# Binance Futures Telegram Bot

Телеграм-бот на Golang для отслеживания открытых позиций на Binance Futures.

## Возможности

- Просмотр открытых позиций на Binance Futures
- Отображение времени сделки в часах и минутах
- Информация о размере позиции (в монетах и USDT), цене входа и PnL с процентом
- Отображение количества исполненных ордеров для каждой позиции
- Установка лимитов времени жизни для позиций по каждой монете
- **Лимиты по количеству исполненных ордеров** (например, разные лимиты для 1-го, 2-го ордера)
- Автоматическая периодическая проверка позиций на превышение лимитов
- Уведомления в Telegram при превышении установленных лимитов (однократно для каждого превышения)
- Настройка интервала проверки позиций

## Требования

- Go 1.21 или выше
- Telegram Bot Token (получить у [@BotFather](https://t.me/BotFather))
- Binance API Key и Secret Key (создать на [Binance API Management](https://www.binance.com/en/my/settings/api-management))

## Установка

1. Клонируйте репозиторий или скачайте файлы проекта

2. Установите зависимости:
```bash
go mod download
```

3. Установите переменные окружения:

### Как получить Telegram Bot Token:

1. Откройте Telegram и найдите бота [@BotFather](https://t.me/BotFather)
2. Отправьте команду `/newbot` или `/start`
3. Укажите имя вашего бота (например: "Binance Futures Tracker")
4. Укажите username бота (должен заканчиваться на `bot`, например: `my_binance_bot`)
5. BotFather пришлет вам токен вида `1234567890:ABCdefGHIjklMNOpqrsTUVwxyz`
6. Скопируйте этот токен и используйте его в переменной окружения

```bash
export TELEGRAM_BOT_TOKEN="ваш_telegram_bot_token"
export BINANCE_API_KEY="ваш_binance_api_key"
export BINANCE_SECRET_KEY="ваш_binance_secret_key"
```

Или создайте файл `.env` (не забудьте добавить его в `.gitignore`):
```bash
TELEGRAM_BOT_TOKEN=ваш_telegram_bot_token
BINANCE_API_KEY=ваш_binance_api_key
BINANCE_SECRET_KEY=ваш_binance_secret_key
```

## Запуск

### Вариант 1: Простой запуск
```bash
go run main.go
```

### Вариант 2: Компиляция и запуск
```bash
go build -o dorcey
./dorcey
```

### Вариант 3: Запуск в фоновом режиме (рекомендуется)
```bash
./run-background.sh
```
Этот скрипт автоматически:
- Проверит, не запущен ли уже бот
- Загрузит переменные из `.env`
- Скомпилирует проект (если нужно)
- Запустит бота в фоне с логированием в `bot.log`
- Сохранит PID процесса в `bot.pid`

### Остановка бота
```bash
./stop-bot.sh
```

## Команды бота

| Команда | Алиас | Описание |
|---------|-------|----------|
| `/start` | — | Начать работу с ботом |
| `/positions` | `/ps` | Показать список открытых позиций на Futures |
| `/add_limit` | `/l` | Добавить или обновить лимит времени |
| `/limits` | `/ls` | Показать список всех установленных лимитов |
| `/lr <coin>` | — | Удалить все лимиты для монеты |
| `/set_check_interval` | — | Установить интервал проверки позиций |

### Примеры команд

**Добавление общего лимита:**
```
/l BTC 12h        — позиция BTC не должна быть открыта более 12 часов
/l ETH 30m        — лимит 30 минут для ETH
/l LSK 1d         — лимит 1 день для LSK
```

**Добавление лимитов по количеству исполненных ордеров:**
```
/l LSK o1 6h      — лимит 6 часов для 1-го исполненного ордера
/l LSK o2 12h     — лимит 12 часов для 2-го исполненного ордера
/l LSK o3 4h      — лимит 4 часа для 3-го исполненного ордера
```

**Удаление лимитов:**
```
/lr LSK           — удалить все лимиты для LSK (общие и по ордерам)
```

**Установка интервала проверки:**
```
/set_check_interval 5m    — проверять каждые 5 минут
/set_check_interval 10m   — проверять каждые 10 минут
/set_check_interval 1h    — проверять каждый час
```

**Единицы времени:** `s` (секунды), `m` (минуты), `h` (часы), `d` (дни)

## Лимиты и автоматические уведомления

Бот поддерживает автоматическую проверку открытых позиций на превышение установленных лимитов времени жизни.

### Как это работает:

1. **Установка лимитов**: Используйте команду `/l` для установки максимального времени жизни позиции
   - Общие лимиты: `/l BTC 12h`
   - Лимиты по количеству ордеров: `/l BTC o1 6h`, `/l BTC o2 12h`

2. **Выбор лимита для проверки**:
   - Если есть точный лимит для текущего количества ордеров (oN) — используется он
   - Если нет точного, ищется ближайший меньший лимит по количеству ордеров
   - Если есть только общий лимит (без oN) — используется он

3. **Автоматическая проверка**: Бот периодически (по умолчанию каждую минуту) проверяет все открытые позиции

4. **Уведомления**: Если время жизни позиции превышает установленный лимит, бот отправляет уведомление с:
   - Информацией о позиции (символ, направление, размер, цена входа, PnL)
   - Количеством исполненных ордеров
   - Временем жизни позиции и установленным лимитом
   - Величиной превышения лимита

5. **Однократные уведомления**: Бот отправляет уведомление о превышении только один раз для каждой комбинации позиция+лимит

### Пример использования:

```
/l LSK 12h          — общий лимит 12 часов
/l LSK o1 6h        — после 1-го ордера лимит 6 часов
/l LSK o2 12h       — после 2-го ордера лимит 12 часов
/l LSK o3 4h        — после 3-го ордера лимит 4 часа
/set_check_interval 1m
```

С такими настройками бот будет применять разные лимиты в зависимости от количества исполненных ордеров в позиции.

## Настройка Binance API

Для работы бота необходимо:

1. Создать API ключ на Binance:
   - Перейдите на [Binance API Management](https://www.binance.com/en/my/settings/api-management)
   - Нажмите "Create API"
   - Выберите "System generated" (рекомендуется) или "Self-generated"
   - Подтвердите создание через email и 2FA

2. Настройте права доступа:
   - **Обязательно**: Включите "Enable Reading" для Futures
   - **Важно**: Убедитесь, что вы создаете ключ для **Futures**, а не для Spot
   - Для чтения позиций достаточно прав на чтение (Enable Reading)

3. Настройка IP whitelist (опционально, но рекомендуется):
   - Если включен IP whitelist, добавьте IP адрес вашего сервера
   - Если не уверены в IP, временно отключите whitelist для тестирования
   - Ваш текущий IP можно узнать из сообщения об ошибке

## Решение проблем

### Ошибка: "Invalid API-key, IP, or permissions for action" (код -2015)

Эта ошибка означает проблему с авторизацией. Проверьте:

1. **Правильность ключей**:
   - Убедитесь, что `BINANCE_API_KEY` и `BINANCE_SECRET_KEY` скопированы правильно
   - Проверьте, что нет лишних пробелов или символов

2. **Права доступа**:
   - Перейдите в настройки API ключа на Binance
   - Убедитесь, что включено "Enable Reading" для **Futures**
   - Проверьте, что ключ создан для Futures, а не для Spot

3. **IP whitelist**:
   - Если включен IP whitelist, добавьте ваш IP адрес
   - Или временно отключите whitelist для тестирования
   - IP адрес указан в сообщении об ошибке

4. **Тип API ключа**:
   - Убедитесь, что используете Futures API ключ
   - Spot API ключи не работают с Futures API

## Структура проекта

```
.
├── main.go              # Основной файл с логикой бота
├── main_test.go         # Тесты
├── go.mod               # Файл зависимостей Go
├── go.sum               # Контрольные суммы зависимостей
├── limits.json          # Файл с лимитами и настройками (создается автоматически)
├── bot.log              # Лог-файл (создается при запуске)
├── bot.pid              # PID файл (создается при фоновом запуске)
├── run-background.sh    # Скрипт запуска в фоновом режиме
├── stop-bot.sh          # Скрипт остановки бота
├── run.sh               # Простой скрипт запуска
├── run-compiled.sh      # Запуск скомпилированного бота
├── dorcey               # Скомпилированный бинарник
├── Requirements.md      # Требования к проекту
└── README.md            # Документация
```

### Файл limits.json

Файл `limits.json` хранит настройки лимитов и интервал проверки. Пример структуры:

```json
{
  "limits": [
    {
      "coin": "BTC",
      "time": "12h"
    },
    {
      "coin": "LSK",
      "time": "6h",
      "order_count": 1
    },
    {
      "coin": "LSK",
      "time": "12h",
      "order_count": 2
    }
  ],
  "check_interval": "1m"
}
```

Поле `order_count`:
- `0` или отсутствует — общий лимит для всей позиции
- `1`, `2`, `3`, ... — лимит для N-го исполненного ордера

⚠️ **Важно**: Файл `limits.json` находится в `.gitignore` и не должен попадать в репозиторий, так как содержит пользовательские настройки.

## Зависимости

- `github.com/adshao/go-binance/v2` - Клиент для Binance API
- `github.com/go-telegram-bot-api/telegram-bot-api/v5` - Клиент для Telegram Bot API

## Безопасность

⚠️ **Важно**: Никогда не публикуйте ваши API ключи в публичных репозиториях. Используйте переменные окружения или файлы конфигурации, которые добавлены в `.gitignore`.
